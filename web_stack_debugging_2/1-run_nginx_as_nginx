#!/bin/bash
# This script configures Nginx to run as the nginx user and listens on port 8080.

# Ensure script runs with sudo
if [[ $EUID -ne 0 ]]; then
    echo "This script must be run as root."
    exit 1
fi

echo "Configuring Nginx to run as the nginx user..."

# Update nginx.conf to set the user as nginx
sed -i 's/^user .*/user nginx;/' /etc/nginx/nginx.conf

echo "Configuring Nginx to listen on 0.0.0.0:8080..."

# Update default server block to listen on port 8080
sed -i 's/listen 80 default_server;/listen 8080 default_server;/' /etc/nginx/sites-available/default
sed -i 's/listen \[::\]:80 default_server;/listen \[::\]:8080 default_server;/' /etc/nginx/sites-available/default

echo "Testing Nginx configuration..."
nginx -t

if [[ $? -ne 0 ]]; then
    echo "Nginx configuration test failed. Please check your configuration."
    exit 1
fi

echo "Restarting Nginx..."
systemctl restart nginx

# Verify that Nginx is running as nginx user
if pgrep -u nginx nginx > /dev/null; then
    echo "Nginx is running as nginx user"
else
    echo "Nginx is NOT running as nginx user"
    exit 1
fi

# Verify that Nginx is listening on port 8080
if netstat -tulnp | grep -q ":8080.*nginx"; then
    echo "Nginx is listening on port 8080"
else
    echo "Nginx is NOT listening on port 8080"
    exit 1
fi

echo "Nginx successfully configured!"

